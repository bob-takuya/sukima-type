var l=Object.defineProperty;var h=(r,e,t)=>e in r?l(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var n=(r,e,t)=>(h(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class d{constructor(e,t,i){n(this,"inputElement");n(this,"onCharacterAdd");n(this,"onCompositionUpdate");n(this,"compositionState");this.inputElement=e,this.onCharacterAdd=t,this.onCompositionUpdate=i,this.compositionState={text:"",isComposing:!1,characters:[]},this.setupEventListeners()}setupEventListeners(){this.inputElement.focus(),document.addEventListener("click",()=>{this.inputElement.focus()}),this.inputElement.addEventListener("compositionstart",()=>{this.compositionState.isComposing=!0}),this.inputElement.addEventListener("compositionupdate",e=>{this.handleCompositionUpdate(e.data)}),this.inputElement.addEventListener("compositionend",e=>{this.handleCompositionEnd(e.data)}),this.inputElement.addEventListener("input",()=>{if(!this.compositionState.isComposing&&this.inputElement.value){const e=this.inputElement.value;for(const t of e)t.trim()&&this.onCharacterAdd(t,!1);this.inputElement.value=""}}),this.inputElement.addEventListener("keydown",e=>{e.key==="Escape"?this.clearComposition():e.key==="F5"||e.metaKey&&e.key==="r"?(e.preventDefault(),this.clearAll()):e.metaKey&&e.key==="z"&&e.preventDefault()})}handleCompositionUpdate(e){if(e){this.clearCompositionCharacters(),this.compositionState.text=e,this.compositionState.characters=[];for(let t=0;t<e.length;t++){const i=e[t];if(i.trim()){const o={id:`composing-${Date.now()}-${t}`,char:i,x:0,y:0,rotation:0,scale:1,isComposing:!0};this.compositionState.characters.push(o),this.onCharacterAdd(i,!0)}}this.onCompositionUpdate(this.compositionState)}}handleCompositionEnd(e){if(!e){this.clearComposition();return}this.clearCompositionCharacters();for(const t of e)t.trim()&&this.onCharacterAdd(t,!1);this.clearComposition(),this.inputElement.value=""}clearCompositionCharacters(){this.onCompositionUpdate({text:"",isComposing:!1,characters:[]})}clearComposition(){this.compositionState={text:"",isComposing:!1,characters:[]},this.inputElement.value=""}clearAll(){this.clearComposition(),document.dispatchEvent(new CustomEvent("clearAll"))}focus(){this.inputElement.focus()}}class u{constructor(e){n(this,"svg");n(this,"characters");this.svg=e,this.characters=new Map,this.setupSVG()}setupSVG(){this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.setAttribute("viewBox",`0 0 ${window.innerWidth} ${window.innerHeight}`),window.addEventListener("resize",()=>{this.svg.setAttribute("viewBox",`0 0 ${window.innerWidth} ${window.innerHeight}`)})}addOrUpdateCharacter(e){const t=this.characters.get(e.id);t?this.updateCharacterElement(t,e):this.createCharacterElement(e),this.characters.set(e.id,e)}createCharacterElement(e){const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("id",e.id),t.setAttribute("x",e.x.toString()),t.setAttribute("y",e.y.toString()),t.setAttribute("font-family",'Helvetica, "Hiragino Kaku Gothic ProN", "ヒラギノ角ゴ ProN W3", Meiryo, sans-serif'),t.setAttribute("font-size",e.scale.toString()),t.setAttribute("text-anchor","middle"),t.setAttribute("dominant-baseline","central"),t.setAttribute("fill",e.isComposing?"#808080":"#FFFFFF"),t.setAttribute("user-select","none"),t.textContent=e.char,e.rotation!==0&&t.setAttribute("transform",`rotate(${e.rotation} ${e.x} ${e.y})`),t.style.opacity="0",this.svg.appendChild(t),requestAnimationFrame(()=>{t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="1"}),e.element=t}updateCharacterElement(e,t){const i=e.element;if(!i)return;(e.x!==t.x||e.y!==t.y||e.rotation!==t.rotation||e.scale!==t.scale)&&(i.style.transition="all 0.3s ease"),i.setAttribute("x",t.x.toString()),i.setAttribute("y",t.y.toString()),i.setAttribute("font-size",t.scale.toString()),i.setAttribute("fill",t.isComposing?"#808080":"#FFFFFF"),t.rotation!==0?i.setAttribute("transform",`rotate(${t.rotation} ${t.x} ${t.y})`):i.removeAttribute("transform"),e.char!==t.char&&(i.textContent=t.char),e.isComposing!==t.isComposing&&i.setAttribute("fill",t.isComposing?"#808080":"#FFFFFF")}removeCharacter(e){const t=this.characters.get(e);!t||!t.element||(t.element.style.transition="opacity 0.2s ease",t.element.style.opacity="0",setTimeout(()=>{t.element&&t.element.parentNode&&t.element.parentNode.removeChild(t.element),this.characters.delete(e)},200))}clearComposingCharacters(){const e=[];this.characters.forEach((t,i)=>{t.isComposing&&e.push(i)}),e.forEach(t=>this.removeCharacter(t))}confirmComposingCharacters(){this.characters.forEach(e=>{e.isComposing&&(e.isComposing=!1,e.element&&e.element.setAttribute("fill","#FFFFFF"))})}updateMultipleCharacters(e){e.forEach(t=>{this.addOrUpdateCharacter(t)})}clear(){this.characters.forEach((e,t)=>{this.removeCharacter(t)}),this.characters.clear()}getCharacterCount(){return this.characters.size}getAllCharacters(){return Array.from(this.characters.values())}}class p{constructor(){n(this,"renderer");n(this,"inputManager");n(this,"layoutWorker");n(this,"characters");n(this,"pendingCalculations");n(this,"fontMetrics");n(this,"isInitialized",!1);this.characters=new Map,this.pendingCalculations=new Set,this.fontMetrics={unitsPerEm:1e3,ascender:800,descender:-200},this.initializeApp()}async initializeApp(){try{await this.initializeComponents(),await this.loadFonts(),this.hideLoading(),this.isInitialized=!0,console.log("Typographic Nesting Art Generator initialized")}catch(e){console.error("Initialization failed:",e),this.showError("初期化に失敗しました。ページを再読み込みしてください。")}}async initializeComponents(){const e=document.getElementById("text-canvas");if(!e)throw new Error("Canvas element not found");this.renderer=new u(e);const t=document.getElementById("input-handler");if(!t)throw new Error("Input element not found");this.inputManager=new d(t,(i,s)=>this.handleCharacterInput(i,s),i=>this.handleCompositionUpdate(i)),this.layoutWorker=new Worker(new URL("/assets/layoutWorker-f79039b0.js",self.location),{type:"module"}),this.layoutWorker.onmessage=i=>{this.handleLayoutResult(i.data)},this.layoutWorker.onerror=i=>{console.error("Layout worker error:",i)},document.addEventListener("clearAll",()=>{this.clearAll()})}async loadFonts(){await document.fonts.ready}hideLoading(){const e=document.getElementById("loading");e&&(e.style.display="none");const t=document.getElementById("instructions");t&&(t.style.opacity="1",setTimeout(()=>{t&&(t.style.opacity="0.3")},5e3))}showError(e){const t=document.getElementById("loading");t&&(t.textContent=e,t.style.color="#ff6b6b")}handleCharacterInput(e,t){if(!this.isInitialized)return;const i=t?`composing-${Date.now()}-${Math.random()}`:`confirmed-${Date.now()}-${Math.random()}`,s={id:i,char:e,x:0,y:0,rotation:0,scale:1,isComposing:t};this.characters.set(i,s),this.calculateLayout(s)}handleCompositionUpdate(e){if(this.isInitialized&&!e.isComposing){this.renderer.clearComposingCharacters();const t=[];this.characters.forEach((i,s)=>{i.isComposing&&t.push(s)}),t.forEach(i=>{this.characters.delete(i)}),this.updateCharacterCount()}}calculateLayout(e){if(this.pendingCalculations.has(e.id))return;this.pendingCalculations.add(e.id);const t={type:"calculate",characters:Array.from(this.characters.values()).filter(i=>i.id!==e.id),newChar:e.char,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight,fontMetrics:this.fontMetrics};this.layoutWorker.postMessage(t)}handleLayoutResult(e){if(e.type!=="result")return;let t;this.characters.forEach(i=>{this.pendingCalculations.has(i.id)&&(t=i)}),t&&(this.pendingCalculations.delete(t.id),t.x=e.placement.x,t.y=e.placement.y,t.rotation=e.placement.rotation,t.scale=e.placement.scale,this.renderer.addOrUpdateCharacter(t),this.updateCharacterCount(),t.isComposing||this.recalculateComposingCharacters(),this.logPerformanceMetrics())}logPerformanceMetrics(){this.characters.size%10===0&&console.log(`Performance: ${this.characters.size} characters, ${this.pendingCalculations.size} pending calculations`)}updateCharacterCount(){const e=document.getElementById("char-count"),t=document.getElementById("performance");if(e){const i=Array.from(this.characters.values()).filter(o=>!o.isComposing).length,s=Array.from(this.characters.values()).filter(o=>o.isComposing).length;e.textContent=`Characters: ${i}${s>0?` (+${s} composing)`:""}`}if(t){const i=this.pendingCalculations.size,s=i>5?"Calculating...":i>2?"Good":"Excellent";t.textContent=`Performance: ${s}`}}recalculateComposingCharacters(){const e=[];this.characters.forEach(t=>{t.isComposing&&e.push(t)}),e.forEach(t=>{this.calculateLayout(t)})}clearAll(){this.renderer.clear(),this.characters.clear(),this.pendingCalculations.clear(),this.updateCharacterCount(),console.log("All characters cleared")}destroy(){this.layoutWorker&&this.layoutWorker.terminate(),this.renderer.clear(),this.characters.clear()}}let c;document.addEventListener("DOMContentLoaded",()=>{c=new p});window.addEventListener("beforeunload",()=>{c&&c.destroy()});
